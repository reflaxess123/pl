# Развертывание на Coolify

## Предварительные требования

1. **Аккаунт на Coolify** и настроенная инстанция
2. **Git репозиторий** с вашим проектом (GitHub, GitLab, etc.)
3. **Файл session.session** - нужно будет отдельно загрузить

## Подготовка проекта

### 1. Убедитесь что есть все необходимые файлы:

- `Dockerfile` ✅
- `docker-compose.yml` ✅
- `.dockerignore` ✅
- `pyproject.toml` и `poetry.lock` ✅
- Исходный код в папке `pl/` ✅

### 2. Подготовьте переменные окружения

Создайте список переменных окружения для Coolify:

```env
PROXY_API_KEY=your_api_key_here
TELEGRAM_API_ID=your_api_id_here
TELEGRAM_API_HASH=your_api_hash_here
TELEGRAM_PHONE=your_phone_number_here
SYSTEM_PROMPT=Ты - персональный ассистент пользователя в Telegram. Работай от его имени, отвечай кратко и по делу.
```

**⚠️ ВАЖНО:** НЕ добавляйте реальные API ключи в Git репозиторий!

## Развертывание на Coolify

### Шаг 1: Создание приложения

1. Войдите в панель управления Coolify
2. Нажмите "New Resource" → "Application"
3. Выберите ваш Git репозиторий
4. Выберите ветку (обычно `main` или `master`)

### Шаг 2: Настройка Build Pack

1. В настройках приложения выберите **"Dockerfile"**
2. Путь к Dockerfile: `./Dockerfile`
3. Контекст сборки: `./`

### Шаг 3: Переменные окружения

Добавьте переменные окружения в разделе "Environment Variables":

```
PROXY_API_KEY = [ваш ключ ProxyAPI]
TELEGRAM_API_ID = [ваш API ID]
TELEGRAM_API_HASH = [ваш API Hash]
TELEGRAM_PHONE = [ваш номер телефона]
SYSTEM_PROMPT = Ты - персональный ассистент пользователя в Telegram. Работай от его имени, отвечай кратко и по делу.
```

### Шаг 4: Настройка хранилища для session.session

**Вариант 1: Persistent Volume (Рекомендуется)**

1. В разделе "Storages" создайте новое хранилище:

   - Name: `telegram-session`
   - Mount Path: `/app/session.session`
   - Type: `File`

2. После создания хранилища загрузите ваш файл `session.session` через файловый менеджер Coolify

**Вариант 2: Через переменную окружения (для тестирования)**

Если файл сессии небольшой, можно закодировать его в base64:

```bash
# На локальной машине
base64 session.session > session_base64.txt
```

Затем добавить переменную:

```
SESSION_BASE64 = [содержимое session_base64.txt]
```

И модифицировать Dockerfile для декодирования.

### Шаг 5: Настройка команды запуска

В разделе "Build & Deploy" установите:

**Start Command:**

```bash
python -m pl.cli telegram
```

**Для расширенного режима:**

```bash
python -m pl.cli telegram --advanced
```

### Шаг 6: Сетевые настройки

1. Если приложение не нуждается в внешнем доступе, отключите "Public Access"
2. Если нужен веб-интерфейс (в будущем), настройте домен

## Деплой и мониторинг

### Запуск деплоя

1. Нажмите "Deploy" в панели управления
2. Следите за логами сборки в реальном времени
3. После успешной сборки приложение автоматически запустится

### Мониторинг

**Просмотр логов:**

```bash
# В панели Coolify перейдите в "Logs"
# Или используйте CLI если настроен:
coolify logs [app-name]
```

**Проверка статуса:**

- Зайдите в раздел "Metrics" в панели управления
- Проверьте потребление ресурсов
- Следите за логами на предмет ошибок

## Обновление приложения

1. Внесите изменения в код
2. Сделайте commit и push в Git репозиторий
3. В Coolify нажмите "Redeploy" или настройте автоматический деплой

## Управление файлом session.session

### Резервное копирование

Регулярно скачивайте файл сессии из Coolify для резервного копирования.

### Обновление сессии

Если нужно обновить сессию:

1. Остановите приложение
2. Замените файл через файловый менеджер Coolify
3. Запустите приложение заново

## Решение проблем

### Приложение не запускается

1. Проверьте логи сборки на ошибки
2. Убедитесь что все переменные окружения заданы
3. Проверьте наличие файла session.session

### Telegram бот не отвечает

1. Проверьте логи приложения
2. Убедитесь в корректности API данных Telegram
3. Проверьте что файл session.session актуален

### Ошибки ProxyAPI

1. Проверьте баланс аккаунта
2. Убедитесь в корректности API ключа
3. Проверьте сетевое подключение контейнера

## Полезные команды

**Для отладки через SSH (если доступно):**

```bash
# Войти в контейнер
docker exec -it [container-name] /bin/bash

# Проверить файлы
ls -la /app/

# Проверить переменные окружения
env | grep -E "(PROXY|TELEGRAM)"

# Тестовый запрос
python -m pl.cli balance
```
