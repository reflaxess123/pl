<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Telegram Bot Manager</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        font-weight: 600;
      }

      .status-badge {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 25px;
        font-weight: 500;
        font-size: 0.9rem;
        margin-top: 10px;
      }

      .status-online {
        background: #27ae60;
        color: white;
      }

      .status-offline {
        background: #e74c3c;
        color: white;
      }

      .main-content {
        padding: 30px;
      }

      .dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
      }

      .card {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        padding: 25px;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      }

      .card h3 {
        color: #2c3e50;
        margin-bottom: 15px;
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .icon {
        font-size: 1.5rem;
      }

      .btn {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        transition: all 0.2s;
        margin: 5px;
        text-decoration: none;
        display: inline-block;
        text-align: center;
      }

      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
      }

      .btn-success {
        background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
      }

      .btn-danger {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      }

      .btn-info {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
      }

      .input-group {
        margin-bottom: 15px;
      }

      .input-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #2c3e50;
      }

      .input-group input,
      .input-group textarea {
        width: 100%;
        padding: 10px;
        border: 2px solid #e9ecef;
        border-radius: 6px;
        font-size: 1rem;
        transition: border-color 0.2s;
      }

      .input-group input:focus,
      .input-group textarea:focus {
        outline: none;
        border-color: #3498db;
      }

      .logs {
        background: #2c3e50;
        color: #ecf0f1;
        border-radius: 8px;
        padding: 20px;
        max-height: 300px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 0.9rem;
        line-height: 1.4;
      }

      .log-entry {
        margin-bottom: 8px;
        padding: 5px;
        border-radius: 4px;
      }

      .log-info {
        background: rgba(52, 152, 219, 0.2);
      }

      .log-error {
        background: rgba(231, 76, 60, 0.2);
      }

      .balance {
        font-size: 1.2rem;
        font-weight: 600;
        color: #27ae60;
      }

      .loading {
        opacity: 0.6;
        pointer-events: none;
      }

      .response-area {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        min-height: 100px;
        white-space: pre-wrap;
      }

      .alert {
        padding: 12px 16px;
        border-radius: 6px;
        margin-bottom: 15px;
        font-weight: 500;
      }

      .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      @media (max-width: 768px) {
        .dashboard {
          grid-template-columns: 1fr;
        }

        .header h1 {
          font-size: 2rem;
        }

        .main-content {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ü§ñ Telegram Bot Manager</h1>
        <div
          class="status-badge {% if is_bot_running %}status-online{% else %}status-offline{% endif %}"
          id="status-badge"
        >
          {% if is_bot_running %} üü¢ –ë–æ—Ç –æ–Ω–ª–∞–π–Ω {% else %} üî¥ –ë–æ—Ç –æ—Ñ–ª–∞–π–Ω {%
          endif %}
        </div>
      </div>

      <div class="main-content">
        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div id="alerts"></div>

        <div class="dashboard">
          <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º -->
          <div class="card">
            <h3><span class="icon">‚ö°</span> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º</h3>
            <div style="margin-bottom: 15px">
              <button
                class="btn btn-success"
                onclick="startBot()"
                id="start-btn"
                {%
                if
                is_bot_running
                %}style="display:none"
                {%
                endif
                %}
              >
                üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
              </button>
              <button
                class="btn btn-danger"
                onclick="stopBot()"
                id="stop-btn"
                {%
                if
                not
                is_bot_running
                %}style="display:none"
                {%
                endif
                %}
              >
                üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞
              </button>
            </div>
            <div class="balance">
              üí∞ –ë–∞–ª–∞–Ω—Å: <span id="balance">{{ balance }}</span>
            </div>
            <button class="btn btn-info" onclick="updateBalance()">
              üîÑ –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å
            </button>
          </div>

          <!-- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ GPT -->
          <div class="card">
            <h3><span class="icon">üß†</span> –¢–µ—Å—Ç GPT</h3>
            <div class="input-group">
              <label for="test-prompt">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</label>
              <textarea
                id="test-prompt"
                rows="3"
                placeholder="–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?"
              ></textarea>
            </div>
            <button class="btn" onclick="testGPT()">üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å GPT</button>
            <div
              id="gpt-response"
              class="response-area"
              style="display: none"
            ></div>
          </div>

          <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
          <div class="card">
            <h3><span class="icon">‚öôÔ∏è</span> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <div class="input-group">
              <label for="temperature">Temperature (0.0-1.0):</label>
              <input
                type="number"
                id="temperature"
                min="0"
                max="1"
                step="0.1"
                value="{{ settings.temperature }}"
              />
            </div>
            <div class="input-group">
              <label for="max-tokens">Max Tokens:</label>
              <input
                type="number"
                id="max-tokens"
                min="50"
                max="2000"
                value="{{ settings.max_tokens }}"
              />
            </div>
            <button class="btn btn-success" onclick="saveSettings()">
              üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            </button>
          </div>
        </div>

        <!-- –õ–æ–≥–∏ -->
        <div class="card">
          <h3><span class="icon">üìã</span> –õ–æ–≥–∏ –±–æ—Ç–∞</h3>
          <div class="logs" id="logs">
            {% for log in bot_logs %}
            <div class="log-entry log-{{ log.level.lower() }}">
              [{{ log.timestamp }}] {{ log.level }}: {{ log.message }}
            </div>
            {% endfor %}
          </div>
          <button
            class="btn btn-info"
            onclick="updateLogs()"
            style="margin-top: 10px"
          >
            üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏
          </button>
        </div>
      </div>
    </div>

    <script>
      let updateInterval;

      function showAlert(message, type = 'success') {
          const alertsDiv = document.getElementById('alerts');
          const alert = document.createElement('div');
          alert.className = `alert alert-${type}`;
          alert.textContent = message;
          alertsDiv.appendChild(alert);

          setTimeout(() => {
              alert.remove();
          }, 5000);
      }

      async function startBot() {
          const startBtn = document.getElementById('start-btn');
          const stopBtn = document.getElementById('stop-btn');
          const statusBadge = document.getElementById('status-badge');

          startBtn.disabled = true;
          startBtn.textContent = '‚è≥ –ó–∞–ø—É—Å–∫...';

          try {
              const response = await fetch('/bot/start', { method: 'POST' });
              const data = await response.json();

              if (data.status === 'success') {
                  showAlert('–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!');
                  startBtn.style.display = 'none';
                  stopBtn.style.display = 'inline-block';
                  statusBadge.className = 'status-badge status-online';
                  statusBadge.textContent = 'üü¢ –ë–æ—Ç –æ–Ω–ª–∞–π–Ω';

                  // –ù–∞—á–∏–Ω–∞–µ–º –æ–±–Ω–æ–≤–ª—è—Ç—å –ª–æ–≥–∏
                  if (!updateInterval) {
                      updateInterval = setInterval(updateLogs, 3000);
                  }
              } else {
                  showAlert(data.message, 'error');
              }
          } catch (error) {
              showAlert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞: ' + error.message, 'error');
          }

          startBtn.disabled = false;
          startBtn.textContent = 'üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞';
      }

      async function stopBot() {
          const startBtn = document.getElementById('start-btn');
          const stopBtn = document.getElementById('stop-btn');
          const statusBadge = document.getElementById('status-badge');

          stopBtn.disabled = true;
          stopBtn.textContent = '‚è≥ –û—Å—Ç–∞–Ω–æ–≤–∫–∞...';

          try {
              const response = await fetch('/bot/stop', { method: 'POST' });
              const data = await response.json();

              if (data.status === 'success') {
                  showAlert('–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!');
                  startBtn.style.display = 'inline-block';
                  stopBtn.style.display = 'none';
                  statusBadge.className = 'status-badge status-offline';
                  statusBadge.textContent = 'üî¥ –ë–æ—Ç –æ—Ñ–ª–∞–π–Ω';

                  // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–æ–≤
                  if (updateInterval) {
                      clearInterval(updateInterval);
                      updateInterval = null;
                  }
              } else {
                  showAlert(data.message, 'error');
              }
          } catch (error) {
              showAlert('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞: ' + error.message, 'error');
          }

          stopBtn.disabled = false;
          stopBtn.textContent = 'üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞';
      }

      async function updateBalance() {
          const balanceSpan = document.getElementById('balance');
          const originalText = balanceSpan.textContent;
          balanceSpan.textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';

          try {
              const response = await fetch('/api/balance');
              const data = await response.json();

              if (data.status === 'success') {
                  balanceSpan.textContent = `${data.balance.toFixed(2)} ‚ÇΩ`;
              } else {
                  balanceSpan.textContent = `–û—à–∏–±–∫–∞: ${data.message}`;
              }
          } catch (error) {
              balanceSpan.textContent = originalText;
              showAlert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞: ' + error.message, 'error');
          }
      }

      async function testGPT() {
          const prompt = document.getElementById('test-prompt').value;
          const responseDiv = document.getElementById('gpt-response');

          if (!prompt.trim()) {
              showAlert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!', 'error');
              return;
          }

          responseDiv.style.display = 'block';
          responseDiv.textContent = '‚è≥ GPT –¥—É–º–∞–µ—Ç...';

          try {
              const response = await fetch('/api/test-gpt', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ prompt: prompt })
              });

              const data = await response.json();

              if (data.status === 'success') {
                  responseDiv.textContent = data.response;
                  showAlert('GPT —Ç–µ—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
              } else {
                  responseDiv.textContent = `–û—à–∏–±–∫–∞: ${data.message}`;
                  showAlert(data.message, 'error');
              }
          } catch (error) {
              responseDiv.textContent = `–û—à–∏–±–∫–∞: ${error.message}`;
              showAlert('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è GPT: ' + error.message, 'error');
          }
      }

      async function saveSettings() {
          const temperature = parseFloat(document.getElementById('temperature').value);
          const maxTokens = parseInt(document.getElementById('max-tokens').value);

          try {
              const response = await fetch('/api/settings', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                      temperature: temperature,
                      max_tokens: maxTokens
                  })
              });

              const data = await response.json();

              if (data.status === 'success') {
                  showAlert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
              } else {
                  showAlert(data.message, 'error');
              }
          } catch (error) {
              showAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫: ' + error.message, 'error');
          }
      }

      async function updateLogs() {
          try {
              const response = await fetch('/api/logs');
              const data = await response.json();

              const logsDiv = document.getElementById('logs');
              logsDiv.innerHTML = '';

              data.logs.slice(-10).forEach(log => {
                  const logEntry = document.createElement('div');
                  logEntry.className = `log-entry log-${log.level.toLowerCase()}`;
                  logEntry.textContent = `[${log.timestamp}] ${log.level}: ${log.message}`;
                  logsDiv.appendChild(logEntry);
              });

              // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑
              logsDiv.scrollTop = logsDiv.scrollHeight;
          } catch (error) {
              console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–æ–≥–æ–≤:', error);
          }
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–≥–∏ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã –µ—Å–ª–∏ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç
      {% if is_bot_running %}
      updateInterval = setInterval(updateLogs, 3000);
      {% endif %}
    </script>
  </body>
</html>
