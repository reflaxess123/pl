<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Telegram Bot Manager</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        font-weight: 600;
      }

      .status-badge {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 25px;
        font-weight: 500;
        font-size: 0.9rem;
        margin-top: 10px;
      }

      .status-online {
        background: #27ae60;
        color: white;
      }

      .status-offline {
        background: #e74c3c;
        color: white;
      }

      .main-content {
        padding: 30px;
      }

      .dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
      }

      .card {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        padding: 25px;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      }

      .card h3 {
        color: #2c3e50;
        margin-bottom: 15px;
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .icon {
        font-size: 1.5rem;
      }

      .btn {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        transition: all 0.2s;
        margin: 5px;
        text-decoration: none;
        display: inline-block;
        text-align: center;
      }

      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
      }

      .btn-success {
        background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
      }

      .btn-danger {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      }

      .btn-info {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
      }

      .input-group {
        margin-bottom: 15px;
      }

      .input-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #2c3e50;
      }

      .input-group input,
      .input-group textarea {
        width: 100%;
        padding: 10px;
        border: 2px solid #e9ecef;
        border-radius: 6px;
        font-size: 1rem;
        transition: border-color 0.2s;
      }

      .input-group input:focus,
      .input-group textarea:focus {
        outline: none;
        border-color: #3498db;
      }

      .logs {
        background: #2c3e50;
        color: #ecf0f1;
        border-radius: 8px;
        padding: 20px;
        max-height: 300px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 0.9rem;
        line-height: 1.4;
      }

      .log-entry {
        margin-bottom: 8px;
        padding: 5px;
        border-radius: 4px;
      }

      .log-info {
        background: rgba(52, 152, 219, 0.2);
      }

      .log-error {
        background: rgba(231, 76, 60, 0.2);
      }

      .balance {
        font-size: 1.2rem;
        font-weight: 600;
        color: #27ae60;
      }

      .loading {
        opacity: 0.6;
        pointer-events: none;
      }

      .response-area {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        min-height: 100px;
        white-space: pre-wrap;
      }

      .alert {
        padding: 12px 16px;
        border-radius: 6px;
        margin-bottom: 15px;
        font-weight: 500;
      }

      .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      @media (max-width: 768px) {
        .dashboard {
          grid-template-columns: 1fr;
        }

        .header h1 {
          font-size: 2rem;
        }

        .main-content {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ü§ñ Telegram Bot Manager</h1>
        <div
          class="status-badge {% if is_bot_running %}status-online{% else %}status-offline{% endif %}"
          id="status-badge"
        >
          {% if is_bot_running %} üü¢ –ë–æ—Ç –æ–Ω–ª–∞–π–Ω {% else %} üî¥ –ë–æ—Ç –æ—Ñ–ª–∞–π–Ω {%
          endif %}
        </div>
      </div>

      <div class="main-content">
        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div id="alerts"></div>

        <div class="dashboard">
          <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º -->
          <div class="card">
            <h3><span class="icon">‚ö°</span> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º</h3>
            <div style="margin-bottom: 15px">
              <button
                class="btn btn-success"
                onclick="startBot()"
                id="start-btn"
                {%
                if
                is_bot_running
                %}style="display:none"
                {%
                endif
                %}
              >
                üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
              </button>
              <button
                class="btn btn-danger"
                onclick="stopBot()"
                id="stop-btn"
                {%
                if
                not
                is_bot_running
                %}style="display:none"
                {%
                endif
                %}
              >
                üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞
              </button>
            </div>
            <div class="balance">
              üí∞ –ë–∞–ª–∞–Ω—Å: <span id="balance">{{ balance }}</span>
            </div>
            <button class="btn btn-info" onclick="updateBalance()">
              üîÑ –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å
            </button>
          </div>

          <!-- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ GPT -->
          <div class="card">
            <h3><span class="icon">üß†</span> –¢–µ—Å—Ç GPT</h3>
            <div class="input-group">
              <label for="test-prompt">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</label>
              <textarea
                id="test-prompt"
                rows="3"
                placeholder="–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?"
              ></textarea>
            </div>
            <button class="btn" onclick="testGPT()">üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å GPT</button>
            <div
              id="gpt-response"
              class="response-area"
              style="display: none"
            ></div>
          </div>

          <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
          <div class="card">
            <h3><span class="icon">‚öôÔ∏è</span> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <div class="input-group">
              <label for="temperature">Temperature (0.0-1.0):</label>
              <input
                type="number"
                id="temperature"
                min="0"
                max="1"
                step="0.1"
                value="{{ settings.temperature }}"
              />
            </div>
            <div class="input-group">
              <label for="max-tokens">Max Tokens:</label>
              <input
                type="number"
                id="max-tokens"
                min="50"
                max="2000"
                value="{{ settings.max_tokens }}"
              />
            </div>
            <button class="btn btn-success" onclick="saveSettings()">
              üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            </button>
          </div>

          <!-- –ê–≤—Ç–æ–æ—Ç–≤–µ—Ç -->
          <div class="card">
            <h3><span class="icon">ü§ñ</span> –ê–≤—Ç–æ–æ—Ç–≤–µ—Ç</h3>
            <div class="input-group">
              <label>
                <input
                  type="checkbox"
                  id="auto-reply-enabled"
                  {%
                  if
                  auto_reply_settings.enabled
                  %}checked{%
                  endif
                  %}
                  onchange="toggleAutoReply()"
                />
                –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç
              </label>
            </div>
            <div class="input-group">
              <label for="delay-min">–ú–∏–Ω. –∑–∞–¥–µ—Ä–∂–∫–∞ (—Å–µ–∫):</label>
              <input
                type="number"
                id="delay-min"
                min="1"
                max="60"
                value="{{ auto_reply_settings.delay_min or 5 }}"
              />
            </div>
            <div class="input-group">
              <label for="delay-max">–ú–∞–∫—Å. –∑–∞–¥–µ—Ä–∂–∫–∞ (—Å–µ–∫):</label>
              <input
                type="number"
                id="delay-max"
                min="1"
                max="120"
                value="{{ auto_reply_settings.delay_max or 15 }}"
              />
            </div>
            <div class="input-group">
              <label for="context-messages">–°–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:</label>
              <input
                type="number"
                id="context-messages"
                min="1"
                max="50"
                value="{{ auto_reply_settings.context_messages or 10 }}"
              />
            </div>
            <button class="btn btn-success" onclick="saveAutoReplySettings()">
              üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–∞
            </button>
          </div>
        </div>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞–º–∏ –¥–ª—è –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–∞ -->
        <div class="card">
          <h3><span class="icon">üí¨</span> –î–∏–∞–ª–æ–≥–∏ —Å –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–æ–º</h3>

          <!-- –°–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞ -->
          <div
            style="
              background: #e3f2fd;
              padding: 15px;
              border-radius: 8px;
              margin-bottom: 20px;
            "
          >
            <h4>üìã –í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ª–æ–≥–∏ –¥–ª—è –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–∞</h4>
            <button class="btn btn-info" onclick="loadDialogs()">
              üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∏–∞–ª–æ–≥–∏
            </button>
            <div id="dialogs-list" style="margin-top: 15px"></div>
          </div>

          <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞ –≤—Ä—É—á–Ω—É—é -->
          <div
            style="
              background: #f8f9fa;
              padding: 15px;
              border-radius: 8px;
              margin-bottom: 20px;
            "
          >
            <h4>‚ûï –î–æ–±–∞–≤–∏—Ç—å —á–∞—Ç –≤—Ä—É—á–Ω—É—é</h4>
            <div class="input-group">
              <label for="new-chat-id">ID —á–∞—Ç–∞:</label>
              <input
                type="number"
                id="new-chat-id"
                placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: -1001234567890"
              />
            </div>
            <div class="input-group">
              <label for="new-chat-name">–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞:</label>
              <input type="text" id="new-chat-name" placeholder="–ú–æ–π –¥—Ä—É–≥" />
            </div>
            <button class="btn btn-success" onclick="addAutoReplyChat()">
              ‚ûï –î–æ–±–∞–≤–∏—Ç—å —á–∞—Ç
            </button>
            <p style="margin-top: 10px; font-size: 0.9rem; color: #6c757d">
              üí° –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤ –≤—ã—à–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
            </p>
          </div>

          <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
          <div id="auto-reply-chats">
            {% for chat in auto_reply_chats %}
            <div class="chat-item" data-chat-id="{{ chat.chat_id }}">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  padding: 10px;
                  border: 1px solid #e9ecef;
                  border-radius: 6px;
                  margin-bottom: 10px;
                "
              >
                <div>
                  <strong>{{ chat.name }}</strong><br />
                  <small style="color: #6c757d">ID: {{ chat.chat_id }}</small>
                </div>
                <div>
                  <label style="margin-right: 10px">
                    <input
                      type="checkbox"
                      {%
                      if
                      chat.enabled
                      %}checked{%
                      endif
                      %}
                      onchange="toggleChatAutoReply({{ chat.chat_id }})"
                    />
                    –í–∫–ª—é—á–µ–Ω
                  </label>
                  <button
                    class="btn btn-danger"
                    style="padding: 5px 10px; font-size: 0.8rem"
                    onclick="removeAutoReplyChat({{ chat.chat_id }})"
                  >
                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                  </button>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>

          <button
            class="btn btn-info"
            onclick="updateAutoReplyChatsList()"
            style="margin-top: 10px"
          >
            üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
          </button>
        </div>

        <!-- –õ–æ–≥–∏ -->
        <div class="card">
          <h3><span class="icon">üìã</span> –õ–æ–≥–∏ –±–æ—Ç–∞</h3>
          <div class="logs" id="logs">
            {% for log in bot_logs %}
            <div class="log-entry log-{{ log.level.lower() }}">
              [{{ log.timestamp }}] {{ log.level }}: {{ log.message }}
            </div>
            {% endfor %}
          </div>
          <button
            class="btn btn-info"
            onclick="updateLogs()"
            style="margin-top: 10px"
          >
            üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏
          </button>
        </div>
      </div>
    </div>

    <script>
      let updateInterval;

      function showAlert(message, type = 'success') {
          const alertsDiv = document.getElementById('alerts');
          const alert = document.createElement('div');
          alert.className = `alert alert-${type}`;
          alert.textContent = message;
          alertsDiv.appendChild(alert);

          setTimeout(() => {
              alert.remove();
          }, 5000);
      }

      async function startBot() {
          const startBtn = document.getElementById('start-btn');
          const stopBtn = document.getElementById('stop-btn');
          const statusBadge = document.getElementById('status-badge');

          startBtn.disabled = true;
          startBtn.textContent = '‚è≥ –ó–∞–ø—É—Å–∫...';

          try {
              const response = await fetch('/bot/start', { method: 'POST' });
              const data = await response.json();

              if (data.status === 'success') {
                  showAlert('–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!');
                  startBtn.style.display = 'none';
                  stopBtn.style.display = 'inline-block';
                  statusBadge.className = 'status-badge status-online';
                  statusBadge.textContent = 'üü¢ –ë–æ—Ç –æ–Ω–ª–∞–π–Ω';

                  // –ù–∞—á–∏–Ω–∞–µ–º –æ–±–Ω–æ–≤–ª—è—Ç—å –ª–æ–≥–∏
                  if (!updateInterval) {
                      updateInterval = setInterval(updateLogs, 3000);
                  }
              } else {
                  showAlert(data.message, 'error');
              }
          } catch (error) {
              showAlert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞: ' + error.message, 'error');
          }

          startBtn.disabled = false;
          startBtn.textContent = 'üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞';
      }

      async function stopBot() {
          const startBtn = document.getElementById('start-btn');
          const stopBtn = document.getElementById('stop-btn');
          const statusBadge = document.getElementById('status-badge');

          stopBtn.disabled = true;
          stopBtn.textContent = '‚è≥ –û—Å—Ç–∞–Ω–æ–≤–∫–∞...';

          try {
              const response = await fetch('/bot/stop', { method: 'POST' });
              const data = await response.json();

              if (data.status === 'success') {
                  showAlert('–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!');
                  startBtn.style.display = 'inline-block';
                  stopBtn.style.display = 'none';
                  statusBadge.className = 'status-badge status-offline';
                  statusBadge.textContent = 'üî¥ –ë–æ—Ç –æ—Ñ–ª–∞–π–Ω';

                  // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–æ–≤
                  if (updateInterval) {
                      clearInterval(updateInterval);
                      updateInterval = null;
                  }
              } else {
                  showAlert(data.message, 'error');
              }
          } catch (error) {
              showAlert('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞: ' + error.message, 'error');
          }

          stopBtn.disabled = false;
          stopBtn.textContent = 'üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞';
      }

      async function updateBalance() {
          const balanceSpan = document.getElementById('balance');
          const originalText = balanceSpan.textContent;
          balanceSpan.textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';

          try {
              const response = await fetch('/api/balance');
              const data = await response.json();

              if (data.status === 'success') {
                  balanceSpan.textContent = `${data.balance.toFixed(2)} ‚ÇΩ`;
              } else {
                  balanceSpan.textContent = `–û—à–∏–±–∫–∞: ${data.message}`;
              }
          } catch (error) {
              balanceSpan.textContent = originalText;
              showAlert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞: ' + error.message, 'error');
          }
      }

      async function testGPT() {
          const prompt = document.getElementById('test-prompt').value;
          const responseDiv = document.getElementById('gpt-response');

          if (!prompt.trim()) {
              showAlert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!', 'error');
              return;
          }

          responseDiv.style.display = 'block';
          responseDiv.textContent = '‚è≥ GPT –¥—É–º–∞–µ—Ç...';

          try {
              const response = await fetch('/api/test-gpt', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ prompt: prompt })
              });

              const data = await response.json();

              if (data.status === 'success') {
                  responseDiv.textContent = data.response;
                  showAlert('GPT —Ç–µ—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
              } else {
                  responseDiv.textContent = `–û—à–∏–±–∫–∞: ${data.message}`;
                  showAlert(data.message, 'error');
              }
          } catch (error) {
              responseDiv.textContent = `–û—à–∏–±–∫–∞: ${error.message}`;
              showAlert('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è GPT: ' + error.message, 'error');
          }
      }

      async function saveSettings() {
          const temperature = parseFloat(document.getElementById('temperature').value);
          const maxTokens = parseInt(document.getElementById('max-tokens').value);

          try {
              const response = await fetch('/api/settings', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                      temperature: temperature,
                      max_tokens: maxTokens
                  })
              });

              const data = await response.json();

              if (data.status === 'success') {
                  showAlert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
              } else {
                  showAlert(data.message, 'error');
              }
          } catch (error) {
              showAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫: ' + error.message, 'error');
          }
      }

      async function updateLogs() {
          try {
              const response = await fetch('/api/logs');
              const data = await response.json();

              const logsDiv = document.getElementById('logs');
              logsDiv.innerHTML = '';

              data.logs.slice(-10).forEach(log => {
                  const logEntry = document.createElement('div');
                  logEntry.className = `log-entry log-${log.level.toLowerCase()}`;
                  logEntry.textContent = `[${log.timestamp}] ${log.level}: ${log.message}`;
                  logsDiv.appendChild(logEntry);
              });

              // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑
              logsDiv.scrollTop = logsDiv.scrollHeight;
          } catch (error) {
              console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–æ–≥–æ–≤:', error);
          }
      }

              // === –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–∞–º–∏ ===

        async function toggleAutoReply() {
            const enabled = document.getElementById('auto-reply-enabled').checked;

            try {
                const response = await fetch('/api/auto-reply/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: enabled })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    showAlert(`–ê–≤—Ç–æ–æ—Ç–≤–µ—Ç ${enabled ? '–≤–∫–ª—é—á–µ–Ω' : '–≤—ã–∫–ª—é—á–µ–Ω'}!`);
                } else {
                    showAlert(data.message, 'error');
                }
            } catch (error) {
                showAlert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–∞: ' + error.message, 'error');
            }
        }

        async function saveAutoReplySettings() {
            const delayMin = parseInt(document.getElementById('delay-min').value);
            const delayMax = parseInt(document.getElementById('delay-max').value);
            const contextMessages = parseInt(document.getElementById('context-messages').value);
            const enabled = document.getElementById('auto-reply-enabled').checked;

            try {
                const response = await fetch('/api/auto-reply/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        delay_min: delayMin,
                        delay_max: delayMax,
                        context_messages: contextMessages,
                        enabled: enabled
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    showAlert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
                } else {
                    showAlert(data.message, 'error');
                }
            } catch (error) {
                showAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–∞: ' + error.message, 'error');
            }
        }

        async function addAutoReplyChat() {
            const chatId = document.getElementById('new-chat-id').value;
            const chatName = document.getElementById('new-chat-name').value;

            if (!chatId || !chatName) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ ID –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞!', 'error');
                return;
            }

            try {
                const response = await fetch('/api/auto-reply/chats/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: parseInt(chatId),
                        chat_name: chatName
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    showAlert('–ß–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–∞!');
                    document.getElementById('new-chat-id').value = '';
                    document.getElementById('new-chat-name').value = '';
                    updateAutoReplyChatsList();
                } else {
                    showAlert(data.message, 'error');
                }
            } catch (error) {
                showAlert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —á–∞—Ç–∞: ' + error.message, 'error');
            }
        }

                async function removeAutoReplyChat(chatId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —á–∞—Ç –∏–∑ –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–∞?')) {
                return;
            }

            try {
                const response = await fetch('/api/auto-reply/chats/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_id: chatId })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    showAlert('–ß–∞—Ç —É–¥–∞–ª–µ–Ω –∏–∑ –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–∞!');
                    updateAutoReplyChatsList();
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤ –µ—Å–ª–∏ –æ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω
                    const dialogsList = document.getElementById('dialogs-list');
                    if (dialogsList.children.length > 0 && !dialogsList.innerHTML.includes('–ó–∞–≥—Ä—É–∑–∫–∞')) {
                        loadDialogs();
                    }
                } else {
                    showAlert(data.message, 'error');
                }
            } catch (error) {
                showAlert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —á–∞—Ç–∞: ' + error.message, 'error');
            }
        }

        async function toggleChatAutoReply(chatId) {
            try {
                const response = await fetch('/api/auto-reply/chats/toggle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_id: chatId })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    showAlert(data.message);
                } else {
                    showAlert(data.message, 'error');
                }
            } catch (error) {
                showAlert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–∞: ' + error.message, 'error');
            }
        }

                async function updateAutoReplyChatsList() {
            try {
                const response = await fetch('/api/auto-reply/chats');
                const data = await response.json();

                if (data.status === 'success') {
                    const chatsContainer = document.getElementById('auto-reply-chats');
                    chatsContainer.innerHTML = '';

                    data.chats.forEach(chat => {
                        const chatDiv = document.createElement('div');
                        chatDiv.className = 'chat-item';
                        chatDiv.dataset.chatId = chat.chat_id;

                        chatDiv.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #e9ecef; border-radius: 6px; margin-bottom: 10px;">
                                <div>
                                    <strong>${chat.name}</strong><br>
                                    <small style="color: #6c757d;">ID: ${chat.chat_id}</small>
                                </div>
                                <div>
                                    <label style="margin-right: 10px;">
                                        <input type="checkbox" ${chat.enabled ? 'checked' : ''}
                                               onchange="toggleChatAutoReply(${chat.chat_id})">
                                        –í–∫–ª—é—á–µ–Ω
                                    </label>
                                    <button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.8rem;"
                                            onclick="removeAutoReplyChat(${chat.chat_id})">
                                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                                    </button>
                                </div>
                            </div>
                        `;

                        chatsContainer.appendChild(chatDiv);
                    });
                } else {
                    showAlert(data.message, 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤:', error);
            }
        }

        async function loadDialogs() {
            const dialogsList = document.getElementById('dialogs-list');
            dialogsList.innerHTML = '<p>‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤...</p>';

            try {
                const response = await fetch('/api/dialogs');
                const data = await response.json();

                if (data.status === 'success') {
                    dialogsList.innerHTML = '';

                    if (data.dialogs.length === 0) {
                        dialogsList.innerHTML = '<p>üì≠ –î–∏–∞–ª–æ–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                        return;
                    }

                    data.dialogs.forEach(dialog => {
                        const dialogDiv = document.createElement('div');
                        dialogDiv.style.cssText = `
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 10px;
                            border: 1px solid #dee2e6;
                            border-radius: 6px;
                            margin-bottom: 8px;
                            background: ${dialog.auto_reply_enabled ? '#d1ecf1' : '#ffffff'};
                        `;

                        // –≠–º–æ–¥–∑–∏ –¥–ª—è —Ç–∏–ø–∞ —á–∞—Ç–∞
                        let typeEmoji = 'üí¨';
                        if (dialog.type === 'user') typeEmoji = 'üë§';
                        else if (dialog.type === 'group') typeEmoji = 'üë•';
                        else if (dialog.type === 'channel') typeEmoji = 'üì¢';

                        dialogDiv.innerHTML = `
                            <div style="flex: 1;">
                                <div style="font-weight: 500;">
                                    ${typeEmoji} ${dialog.name}
                                    ${dialog.unread_count > 0 ? `<span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; margin-left: 5px;">${dialog.unread_count}</span>` : ''}
                                </div>
                                <small style="color: #6c757d;">
                                    ID: ${dialog.chat_id} ‚Ä¢ –¢–∏–ø: ${dialog.type}
                                    ${dialog.auto_reply_enabled ? ' ‚Ä¢ <strong style="color: #28a745;">–ê–≤—Ç–æ–æ—Ç–≤–µ—Ç –≤–∫–ª—é—á–µ–Ω</strong>' : ''}
                                </small>
                            </div>
                            <div>
                                ${dialog.auto_reply_enabled ?
                                    `<button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.8rem;" onclick="removeAutoReplyChat(${dialog.chat_id})">üî¥ –í—ã–∫–ª—é—á–∏—Ç—å</button>` :
                                    `<button class="btn btn-success" style="padding: 5px 10px; font-size: 0.8rem;" onclick="addDialogToAutoReply(${dialog.chat_id}, '${dialog.name.replace(/'/g, "\\'")}')">üü¢ –í–∫–ª—é—á–∏—Ç—å</button>`
                                }
                            </div>
                        `;

                        dialogsList.appendChild(dialogDiv);
                    });

                    showAlert(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.dialogs.length} –¥–∏–∞–ª–æ–≥–æ–≤`);
                } else {
                    dialogsList.innerHTML = `<p style="color: #dc3545;">‚ùå ${data.message}</p>`;
                    showAlert(data.message, 'error');
                }
            } catch (error) {
                dialogsList.innerHTML = `<p style="color: #dc3545;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–ª–æ–≥–æ–≤</p>`;
                showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–ª–æ–≥–æ–≤: ' + error.message, 'error');
            }
        }

        async function addDialogToAutoReply(chatId, chatName) {
            try {
                const response = await fetch('/api/auto-reply/chats/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: chatId,
                        chat_name: chatName
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    showAlert('–î–∏–∞–ª–æ–≥ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç!');
                    loadDialogs(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
                    updateAutoReplyChatsList(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤
                } else {
                    showAlert(data.message, 'error');
                }
            } catch (error) {
                showAlert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞: ' + error.message, 'error');
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–≥–∏ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã –µ—Å–ª–∏ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç
        {% if is_bot_running %}
        updateInterval = setInterval(updateLogs, 3000);
        {% endif %}
    </script>
  </body>
</html>
